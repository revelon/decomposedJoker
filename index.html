<!doctype html>
<html lang="cs">
<head>
	<meta charset="utf-8">
	<title>Decomposed Joker GUI</title>
	<link rel="icon" type="image/png" href="favicon.ashx">
	<style>
		div#guiHand div div, div#guiNewSets div div, div#guiTable div div { width: 100px; display: table-cell; background-color: beige; }
		div {border: 2px dotted blue; margin: 4px; padding: 4px; }
		div.active {border: 2px dotted red;}
	</style>
	<script>
		"use strict";

		// https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
		// Example POST method implementation:
		async function postData(data = {}) {
			// Default options are marked with *
			const response = await fetch('api.php', {
				method: 'POST', // *GET, POST, PUT, DELETE, etc.
				mode: 'cors', // no-cors, *cors, same-origin
				cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
				credentials: 'same-origin', // include, *same-origin, omit
				headers: {
					'Content-Type': 'application/json'
					// 'Content-Type': 'application/x-www-form-urlencoded',
				},
				redirect: 'follow', // manual, *follow, error
				referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			console.dir(response.text);			
			const ret = await response.json(); // parses JSON response into native JavaScript objects
			if (response.status > 399) {
				throw "Server responded error with: " + ret.message;
			} else {
				return ret.data;
			}
		}

		var allCards = {};
		var playerId = '';
		var hand = [];
		var sets = [];
		var table = [];
		var actives = [];
		var guiHand;
		var guiNewSets;
		var guiTable;

		async function initGame() {
			try {
				const deck = await postData({ action: 'initGame' });
				deck.forEach(c => window.allCards[c.id] = c);
				//console.dir('initGame', window.allCards);
			} catch (err) {
				console.dir('err', err);
			}

			let hand = {};
			hand.id = "0";
			hand.cards = [];
			window.hand.push(hand);

			guiHand = document.getElementById('guiHand');
			guiHand.innerHTML = '';
			guiNewSets = document.getElementById('guiNewSets');
			guiNewSets.innerHTML = '';			
			guiTable = document.getElementById('guiTable');
			guiTable.innerHTML = '';
		}

		async function registerPlayer(name) {
			try {
				window.playerId = await postData({ action: 'registerPlayer', 'name': name });
				console.dir('registerPlayer', window.playerId);
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function getHand(render = false) {
			try {
				window.hand[0].cards = await postData({ action: 'getHand', 'playerId': window.playerId });
				console.dir('getHand', window.hand);
			} catch (err) {
				console.dir('err', err);
			}
			if (render) {
				renderCardGroups(window.hand, guiHand);
			}
		}

		async function getCard() {
			try {
				window.hand[0].cards = await postData({ action: 'getCard', 'playerId': window.playerId });
				console.dir('getCard', window.hand);
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function validateTurn() {
			console.log("validating...");
			// iterate through all new groups
			for(const s in window.sets) {
				console.log('group_id...', s);
				let cards = [];
				window.sets[s].cards.forEach( c => cards.push({id: c, type: window.allCards[c].type, value: window.allCards[c].value}) );
				if (await validateGroup(cards)) {
					console.log('great, valid set id:', s);
				} else {
					console.log('bad luck, invalid set id:', s);
					return false;
				}
			}
			// iterate through modified table TBD
			for(const s in window.table) {
				console.log('group_id...', s);
				let cards = [];
				window.table[s].cards.forEach( c => cards.push({id: c, type: window.allCards[c].type, value: window.allCards[c].value}) );
				if (await validateGroup(cards)) {
					console.log('great, valid set id:', s);
				} else {
					console.log('bad luck, invalid set id:', s);
					return false;
				}
			}

			try {
				let newTbl = [];
				for(const s in window.table) {
					newTbl.push(window.table[s]);
				}
				for(const s in window.sets) {
					newTbl.push(window.sets[s]);
				}
				console.dir('trying to do tableChange...', newTbl);
				window.table = newTbl;
				await doTableChange();
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function validateGroup(group) {
			try {
				const grp = await postData({ action: 'validateGroup', 'cards': group });
				console.dir('validateGroup', grp);
				return grp;
			} catch (err) {
				console.dir('err', err);
				return false;
			}
		}

		async function doTableChange() {
			try {
				let handCards = [];
				window.hand[0].cards.forEach( c => handCards.push({id: c, type: window.allCards[c].type, value: window.allCards[c].value}) );

				let fullTable = [];
				for(const s in window.table) {
					console.log('group_id...', s);
					let cardSet = [];
					window.table[s].cards.forEach( c => cardSet.push({id: c, type: window.allCards[c].type, value: window.allCards[c].value}) );
					fullTable.push(cardSet);
				}
				const turn = await postData({ action: 'doTableChange', 'playerId': window.playerId, 'table': fullTable, 'hand': handCards });
				console.dir('doTableChange', turn);
				// do all loading and rendering, table etc.... !!!!
			} catch (err) {
				console.dir('err', err);
			}
		}


		// non server interactive functions

		function createEmptySet() {
			let set = {};
			set.id = "s" + Math.random().toString(12).substring(2, 8);
			set.cards = [];
			console.dir(set);
			window.sets[set.id] = set;
			renderCardGroups(window.sets, guiNewSets);
		}

		function renderCardGroups(groups, gui) {
			console.dir('rendering', groups);
			gui.innerHTML = '';
			for(const s in groups) {
				console.log('group_id', s);
				const nl = el('div', s, `id: ${groups[s].id}`);
				groups[s].cards.forEach( c => {
					const card = renderCard(c);
					card.addEventListener('click', (e) => activateCard(c), true);
					nl.appendChild(card);
				});
				const butt = el('button', "act-" + s, '+');
				butt.addEventListener('click', (e) => addActiveCardsToSet(s), true);
				nl.appendChild(butt);
				gui.appendChild(nl);
			}
		}

		function addActiveCardsToSet(setId) {
			console.log("set id", setId);
			if (window.sets[setId]) {
				window.sets[setId].cards = window.sets[setId].cards.concat(window.actives);
			}
			window.actives.forEach( a => {
				const x = window.hand[0].cards.indexOf(a);
				if (x > -1) {
					window.hand[0].cards.splice(x, 1);
				} else {
					window.hand[0].cards.push(a);	
				}
			});
			window.actives = [];
			renderCardGroups(window.sets, guiNewSets);
			renderCardGroups(window.hand, guiHand);
		}

		function renderCard(id) {
			return el('div', id, `${window.allCards[id].value}<br>${window.allCards[id].type}`);
		}

		function activateCard(id) {
			const x = window.actives.indexOf(id);
			if (x > -1) {
				window.actives.splice(x, 1);
			} else {
				window.actives.push(id)	
			}
			document.getElementById(id).classList.toggle("active");
			event.stopPropagation();
		}

		function el(element, id, htmlBody) {
			let el = document.createElement(element);
			el.innerHTML = htmlBody;
			el.id = id;
			return el;
		}
	</script>
</head>
<body>

<h1>Decomposed Joker GUI</h1>

<button onclick='initGame()'>Init Game</button>
<button onclick='registerPlayer("marek")'>registerPlayer</button>
<button onclick='getHand(true)'>getHand and renderHand</button>
<button onclick='getCard()'>getCard and end turn</button>
<button onclick='createEmptySet()'>create Empty Set</button>
<button onclick='validateTurn()'>validate all groups of cards as except of hand</button>
<hr>
Hand:
<div id='guiHand'></div>
NewSets:
<div id='guiNewSets'></div>
Table
<div id='guiTable'></div>
<hr>
ulozit si vse pred tahem a nabidnout undo !!


</body>
</html>
