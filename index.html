<!doctype html>
<html lang="cs">
<head>
	<meta charset="utf-8">
	<title>Decomposed Joker GUI</title>
	<link rel="icon" type="image/png" href="favicon.ashx">
	<style>
		div {border: 1px dotted blue; margin: 4px;}
		div.active {border: 2px solid red;}
	</style>
	<script>
		// https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
		// Example POST method implementation:
		async function postData(data = {}) {
			// Default options are marked with *
			const response = await fetch('api.php', {
				method: 'POST', // *GET, POST, PUT, DELETE, etc.
				mode: 'cors', // no-cors, *cors, same-origin
				cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
				credentials: 'same-origin', // include, *same-origin, omit
				headers: {
					'Content-Type': 'application/json'
					// 'Content-Type': 'application/x-www-form-urlencoded',
				},
				redirect: 'follow', // manual, *follow, error
				referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			console.dir(response.text);			
			const ret = await response.json(); // parses JSON response into native JavaScript objects
			if (response.status > 399) {
				throw "Server responded error with: " + ret.message;
			} else {
				return ret.data;
			}
		}

		var game;
		var playerId;
		var hand;
		var table = [];
		var actives = {};   // predelat na zasobnik !!!
		var guiHand;
		var guiTable;

		async function initGame() {
			try {
				window.game = await postData({ action: 'initGame' });
				console.dir('initGame', window.game);
			} catch (err) {
				console.dir('err', err);
			}
			guiHand = document.getElementById('guiHand');
			guiHand.innerHTML = '';
			guiTable = document.getElementById('guiTable');
			guiTable.innerHTML = '';
		}

		async function registerPlayer(name) {
			try {
				window.playerId = await postData({ action: 'registerPlayer', 'name': name });
				console.dir('registerPlayer', window.playerId);
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function getHand(render = false) {
			try {
				window.hand = await postData({ action: 'getHand', 'playerId': window.playerId });
				console.dir('getHand', window.hand);
			} catch (err) {
				console.dir('err', err);
			}
			if (render) {
				renderHand();
			}
		}

		async function getCard() {
			try {
				window.hand = await postData({ action: 'getCard', 'playerId': window.playerId });
				console.dir('getCard', window.hand);
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function getCard() {
			try {
				window.hand = await postData({ action: 'getCard', 'playerId': window.playerId });
				console.dir('getCard', window.hand);
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function validateGroup(group) {
			try {
				const grp = await postData({ action: 'validateGroup', 'cards': group });
				console.dir('validateGroup', grp);
				// rework soon, let more groups to be prepared
				if (grp) {
					window.table.push(group);
					Object.keys(grp).forEach(c => delete window.hand.c);  // ruka nemuze byt objekt, nedrzi poradi!! a delete moc nefunguje 
					await doTableChange();
				}
			} catch (err) {
				console.dir('err', err);
			}
		}

		async function doTableChange() {
			try {
				const turn = await postData({ action: 'doTableChange', 'playerId': window.playerId, 'table': window.table, 'hand': window.hand });
				console.dir('doTableChange', turn);
			} catch (err) {
				console.dir('err', err);
			}
		}


		// non server interactive functions

		function createEmptySet() {
			window.set = {};
		}

		function renderHand() {
			guiHand.innerHTML = '';
			Object.values(hand).forEach(
				(c) => {
							const nl = el('div', c.id, `value:${c.value} - type:${c.type}`);
							nl.addEventListener('click', (e) => activateCard(c.id));
							window.guiHand.appendChild(nl);
						}
					);
		}

		function activateCard(id) {
			if (window.actives[id]) {
				delete window.actives.id;
			} else {
				window.actives[id] = window.hand[id];
			}
			document.getElementById(id).classList.toggle("active");
		}

		function el (element, id, htmlBody) {
			let el = document.createElement(element);
			el.innerHTML = htmlBody;
			el.id = id;
			return el;
		}
	</script>
</head>
<body>

<h1>Decomposed Joker GUI</h1>

<button onclick='initGame()'>Init Game</button>
<button onclick='registerPlayer("marek")'>registerPlayer</button>
<button onclick='getHand(true)'>getHand and renderHand</button>
<button onclick='getCard()'>getCard and end turn</button>
<button onclick='createEmptySet()'>create Empty Set</button>
<button onclick='validateGroup(window.actives)'>validate active group of cards as valid set/group</button>

<div id='guiHand'></div>
<div id='guiTable'></div>

</body>
</html>
